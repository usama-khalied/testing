<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Globe</title>
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <script src="//unpkg.com/topojson-client"></script>
  </head>
  <body>
    <div id="globeViz"></div>
  </body>

  <script type="text/javascript">
    // Gen random data
    const N = 16;
    const gData = [...Array(N).keys()].map(() => ({
      lat: (Math.random() - 0.5) * 180,
      lng: (Math.random() - 0.5) * 360
    }));

    const half = Math.ceil(gData.length / 2);

    const firstHalf = gData.slice(0, half);
    const secondHalf = gData.slice(-half);

    var arcsData = [];

    for (let i = 0; i < half; i++) {
      const start = firstHalf[i];
      const end = secondHalf[i];

      console.log("push new point");
      arcsData.push({
        startLat: start.lat,
        startLng: start.lng,
        endLat: end.lat,
        endLng: end.lng,
        color: "#e6002c"
      });
    }

    const colorInterpolator = (t) => `rgba(92, 201, 245,${Math.sqrt(1 - t)})`;

    // GDP per capita (avoiding countries with small pop)
    const getVal = (feat) =>
      feat.properties.GDP_MD_EST / Math.max(1e5, feat.properties.POP_EST);

    const world = Globe({ waitForGlobeReady: true })(
      document.getElementById("globeViz")
    )
      .backgroundColor("rgba(0,0,0,0)")
      .height(720)
      .width(720)
      // .waitForGlobeReady(true)
      .showGlobe(true)
      .showGraticules(true)
      .showAtmosphere(false)
      .ringsData(gData)
      // .ringAltitude(0.02)
      .ringColor(() => "blue")
      .ringResolution(13)
      .ringMaxRadius(0.75)
      //.ringPropagationSpeed()
      .ringPropagationSpeed(3)
      .ringRepeatPeriod(1);

    const globeMaterial = world.globeMaterial();

    globeMaterial.specular = new THREE.Color("#FECDCD");
    globeMaterial.shininess = 0;
    globeMaterial.color = new THREE.Color("#e6002c");
    globeMaterial.opacity = 0.1;

    fetch("./data.json")
      .then((res) => res.json())
      .then((countries) => {
        // console.log(points);

        world
          .hexPolygonsData(countries)
          .hexPolygonGeoJsonGeometry((it) => it)
          .hexPolygonResolution(3)
          .hexPolygonMargin(0.4)
          .hexPolygonColor(() => "#e6002c");

        /*world
          .polygonsData(countries)
          .polygonGeoJsonGeometry((it) => it)
          .polygonAltitude(0.1)
          .polygonCapColor((feat) => "rgba(0, 0, 0, 0)")
          .polygonSideColor(() => "rgba(0, 0, 0, 0)")
          .polygonStrokeColor(() => "#E02B2B99");*/

        world
          .arcsData(arcsData)
          .arcColor(() => "#B8743D")
          .arcStroke(0.45)
          .arcDashInitialGap(0.25)
          // .arcAltitude(0.5)
          .arcAltitudeAutoScale(0.5)
          .arcDashLength(1)
          .arcDashGap(0.5)
          .arcDashAnimateTime(() => Math.random() * 8000 + 500);
      });

    world.controls().enableZoom = false;
    world.controls().autoRotate = true;
    world.controls().rotateSpeed = 0.05;
    world.controls().autoRotateSpeed = 0.5;

    console.log(world.controls());

    //disable controls on mobile
    if (
      /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      )
    ) {
      world.controls().enabled = false;
    }

    world.pointOfView({ altitude: 2.0, lat: 45.508888, lng: -73.561668 });
    // console.log(world);
  </script>
</html>
